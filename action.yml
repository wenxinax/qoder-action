
name: 'Qoder Action'
description: 'A flexible and composable GitHub Action framework for qoder-cli.'
author: 'qoder-ai'

inputs:
  scene:
    description: |
      The scenario for the action, determining built-in prompts and logic.
      - `cr`: Code Review mode. Uses built-in prompts for code analysis. Allows customization via `append_prompt`.
      - `mention`: Mention mode. Responds to user mentions in comments. Allows customization of reply style via `append_prompt`.
      - `custom`: Custom mode. Requires a `prompt` to define the task, and allows a custom `system_prompt`.
    required: true
    default: 'cr'

  append_prompt:
    description: 'For `cr` or `mention` scenes. Appends additional instructions to the built-in prompt.'
    required: false

  prompt:
    description: "Required for `custom` scene. A detailed prompt that tells qoder what to do."
    required: false
  system_prompt:
    description: "Optional for `custom` scene. A system prompt to guide the model's behavior. A default is used if not provided."
    required: false


  dashscope_api_key:
    description: 'The Dashscope API key for LLM services.'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Dispatcher
      id: dispatcher
      # Execute the compiled dispatcher script directly instead of calling the action recursively
      run: node ${{ github.action_path }}/dist/dispatcher.js
      shell: bash
      env:
        INPUT_SCENE: ${{ inputs.scene }}
        INPUT_APPEND_PROMPT: ${{ inputs.append_prompt }}
        INPUT_PROMPT: ${{ inputs.prompt }}
        INPUT_SYSTEM_PROMPT: ${{ inputs.system_prompt }}

    - name: Run Qoder Core Action
      id: qoder
      uses: wenxinax/qoder-core-action@main
      with:
        system_prompt_path: ${{ steps.dispatcher.outputs.system_prompt_path }}
        prompt_path: ${{ steps.dispatcher.outputs.prompt_path }}
        config: ${{ steps.dispatcher.outputs.qoder_config_json }}
        dashscope_api_key: ${{ inputs.dashscope_api_key }}
      env:
        GITHUB_TOKEN: ${{ steps.dispatcher.outputs.github_token }}

    - name: Finalize
      id: finalize
      if: always()
      # Execute the compiled finalize script directly
      run: node ${{ github.action_path }}/dist/finalize.js
      shell: bash
      env:
        INPUT_SCENE: ${{ inputs.scene }}
        INPUT_COMMENT_ID: ${{ steps.dispatcher.outputs.comment_id }}
        INPUT_JOB_STATUS: ${{ job.status }}
        INPUT_QODER_RESULT: ${{ steps.qoder.outputs.result }}
        INPUT_GITHUB_TOKEN: ${{ steps.dispatcher.outputs.github_token }}
        INPUT_COMMENT_TYPE: ${{ steps.dispatcher.outputs.comment_type }}
